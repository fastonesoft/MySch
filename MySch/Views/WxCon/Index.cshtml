
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>报名注册</title>
    <script src="~/Scripts/jquery-3.1.1.min.js"></script>

    <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>

    <link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/1.1.2/weui.min.css">
    <script type="text/javascript" src="https://res.wx.qq.com/open/libs/weuijs/1.1.1/weui.min.js"></script>
    <script type="text/javascript">
        $(function () {
            //提示
            var headloading = weui.loading('正在加载...');
            //加载js
            $.post('/Regs/Jssdk', function (jsres) {
                if (jsres.error) {
                    weui.topTips(jsres.message, 3000);
                } else {
                    //关闭
                    headloading.hide();

                    //后注册
                    wx.config({
                        debug: false,
                        appId: jsres.appid,
                        timestamp: jsres.timestamp,
                        nonceStr: jsres.noncestr,
                        signature: jsres.signature,
                        jsApiList: [
                          'hideAllNonBaseMenuItem',
                          'chooseImage',
                          'uploadImage',
                          'closeWindow',
                          'checkJsApi',
                          'hideMenuItems',
                          'translateVoice',
                          'previewImage',
                          'hideOptionMenu',
                          'scanQRCode',
                          'chooseWXPay',
                          'downloadImage',
                          'onMenuShareTimeline',
                          'onMenuShareAppMessage',
                          'onMenuShareQQ',
                          'onMenuShareWeibo',
                          'onMenuShareQZone',
                          'showMenuItems',
                          'showAllNonBaseMenuItem',
                          'startRecord',
                          'stopRecord',
                          'onVoiceRecordEnd',
                          'playVoice',
                          'onVoicePlayEnd',
                          'pauseVoice',
                          'stopVoice',
                          'uploadVoice',
                          'downloadVoice',
                          'getNetworkType',
                          'openLocation',
                          'getLocation',
                          'showOptionMenu',
                          'openProductSpecificView',
                          'addCard',
                          'chooseCard',
                          'openCard',
                        ]
                    });


                    //
                    wx.ready(function () {
                        //隐藏所有非基本菜单项
                        wx.hideAllNonBaseMenuItem({
                            success: function () {
                                //weui.alert('已隐藏所有非基本菜单项');
                            }
                        });

                        var reg = {
                            IDNUM: /^\d{17}[\dxX]$/,
                            TEL1: /^1(3\d|4[57]|5[0-35-9]|8\d|70)\d{8}$/,
                            TEL2: /^1(3\d|4[57]|5[0-35-9]|8\d|70)\d{8}$|^无$/,
                        };
                        weui.form.checkIfBlur('#regs_reg_form', {
                            regexp: reg
                        });
                        //表单
                        $('#regs_reg_upload').click(function () {
                            weui.form.validate('#regs_reg_form', function (error) {
                                if (!error) {
                                    var loading = weui.loading('正在注册...');
                                    //提交
                                    var data = $('#regs_reg_form').serialize();
                                    $.post('/Regs/Reg', data, function (res) {
                                        //关闭
                                        loading.hide();
                                        //提示
                                        if (res.error) {
                                            if (res.message.key) {
                                                //字段加红
                                                $('#' + res.message.key).addClass('weui-cell_warn');
                                            }
                                            weui.topTips(res.message.value, 3000);
                                        } else {
                                            $('#regs_reged_image').attr('src', '/Image/code/' + res.message.key);
                                            $('#regs_reged_name').text(res.message.value + '：');
                                            $('#regs_reged .weui-btn').removeClass('weui-btn_disabled');
                                            //
                                            $('#regs_reg_form').hide();
                                            $('#regs_reged').fadeIn();
                                            weui.toast('注册成功', 2000);
                                        }
                                    })
                                }
                            }, {
                                regexp: reg
                            });
                        });

                        var syncUpload = function (localIds, uploadtype) {
                            var localId = localIds.pop();
                            wx.uploadImage({
                                localId: localId,
                                isShowProgressTips: 1,
                                success: function (res) {
                                    //对serverId做处理的代码
                                    $.post('/Regs/UploadImageSelf', { mediaID: res.serverId, uploadType: uploadtype }, function (uploadres) {
                                        if (uploadres.error) {
                                            weui.topTips(uploadres.message, 3000);
                                        } else {
                                            //更新
                                            var $id = $('#regs_reged_image_' + uploadtype)
                                            $('<img>').attr('src', '/Image/Uploaded/' + uploadres.message).prependTo($id);
                                        }
                                    })
                                    if (localIds.length > 0) {
                                        syncUpload(localIds, uploadtype);
                                    }
                                }
                            });
                        }

                        //选择图片，上传
                        $('.regs_reged_upload .weui-btn').click(function () {
                            if ($(this).hasClass('weui-btn_disabled')) return;
                            //分类名称
                            var name = $(this).attr('uploadtype');
                            wx.chooseImage({
                                success: function (res) {
                                    syncUpload(res.localIds, name);
                                }
                            });
                        });

                        //图片删除
                        $('.regs_reged_image').on('click', 'img', function () {
                            if (jsres.exam) return;
                            //
                            var $image = $(this);
                            var imageurl = $image.attr('src');
                            var gallery = weui.gallery(imageurl, {
                                onDelete: function () {
                                    weui.confirm('　确定删除该图片？', function () {
                                        gallery.hide();
                                        var loading = weui.loading('正在删除...');
                                        $.post('/Regs/DeleteImage', { url: imageurl }, function (delres) {
                                            loading.hide();
                                            if (delres.error) {
                                                weui.topTips(delres.message, 3000);
                                            } else {
                                                //删除
                                                $($image).remove();
                                                weui.toast(delres.message, 2000);
                                            }
                                        })
                                    }, function () {
                                        gallery.hide();
                                    }, { title: '图片删除' });
                                }
                            });
                        });

                        //显示注册
                        $('#regs_examed_show').click(function () {
                            if ($('#regs_reged').is(":visible")) {
                                $('#regs_reged').hide();
                            } else {
                                $('#regs_reged_message').hide();
                                $('#regs_reged').fadeIn();
                            }
                        });
                    });

                    //错误检测
                    wx.error(function (errores) {
                        weui.alert(JSON.stringify(errores));
                    });
                }
            })
        })
    </script>
    <style type="text/css">
        .regs_reged_image { margin-top: 10px; }
    </style>
</head>
<body>
    <div> 
    </div>
</body>
</html>
